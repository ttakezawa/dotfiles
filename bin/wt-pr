#!/usr/bin/env bash
#
# wt-pr - Create worktree from a PR's HEAD commit
#
# 背景: `git wt <branch> <start-point>` の start-point として PR を指定したいが、
# PR 番号や URL から SHA を取得する手順が煩雑なため、このラッパーを作成。
#
# 依存: gh, jq, git-wt

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BOLD='\033[1m'
NC='\033[0m'

usage() {
    echo "Usage: wt-pr [-q] <PR_NUMBER|PR_URL> [BRANCH] [git-wt options...]"
    echo ""
    echo "Create a worktree from the HEAD commit of the specified PR."
    echo ""
    echo "Options:"
    echo "  -q, --quiet      Output only the worktree path (for scripting/cd)"
    echo "  -h, --help       Show this help message"
    echo ""
    echo "Arguments:"
    echo "  PR_NUMBER|URL    PR number or GitHub PR URL"
    echo "  BRANCH           Name of the branch/worktree to create (default: {Author}-#{PR}-{MMDD})"
    echo ""
    echo "Examples:"
    echo "  wt-pr 123"
    echo "  wt-pr https://github.com/org/repo/pull/123"
    echo "  wt-pr 123 my-branch"
    echo "  wt-pr -q 123                # Output only path (for cd)"
    exit 1
}

# PR URL を正規化する（/files, /changes 等の suffix を除去）
# URL でない場合はそのまま返す
normalize_pr_ref() {
    local ref=$1
    if [[ "$ref" =~ ^https?:// ]]; then
        # URL から PR 部分のみ抽出 (例: https://github.com/org/repo/pull/123)
        echo "$ref" | grep -oE 'https?://[^/]+/[^/]+/[^/]+/pull/[0-9]+' || echo "$ref"
    else
        echo "$ref"
    fi
}

# 依存コマンドチェック
if ! command -v gh &> /dev/null; then
    echo -e "${RED}Error: gh command not found.${NC}" >&2
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo -e "${RED}Error: jq command not found.${NC}" >&2
    exit 1
fi

if ! command -v git-wt &> /dev/null; then
    echo -e "${RED}Error: git-wt command not found.${NC}" >&2
    exit 1
fi

if ! git rev-parse --is-inside-work-tree &> /dev/null; then
    echo -e "${RED}Error: Not a git repository.${NC}" >&2
    exit 1
fi

# 引数チェック
if [[ $# -lt 1 ]]; then
    usage
fi

# オプション解析
quiet=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -q|--quiet)
            quiet=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -lt 1 ]]; then
    usage
fi

pr_ref=$1
shift

# 第2引数がオプション（--で始まる）でなければブランチ名として扱う
branch=""
if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
    branch=$1
    shift
fi

# 残りの引数は git wt に渡すオプション
wt_options=("$@")

# URL の場合は正規化
pr_ref=$(normalize_pr_ref "$pr_ref")

# PR情報を取得
pr_info=$(gh pr view "$pr_ref" --json number,title,headRefName,headRefOid,url,author,createdAt 2>&1) || {
    echo -e "${RED}Error: Failed to fetch PR: ${pr_ref}${NC}" >&2
    echo "$pr_info" >&2
    exit 1
}

pr_number=$(echo "$pr_info" | jq -r '.number')
pr_title=$(echo "$pr_info" | jq -r '.title')
pr_head_branch=$(echo "$pr_info" | jq -r '.headRefName')
pr_sha=$(echo "$pr_info" | jq -r '.headRefOid')
pr_sha_short=${pr_sha:0:7}
pr_url=$(echo "$pr_info" | jq -r '.url')
pr_author=$(echo "$pr_info" | jq -r '.author.login')
pr_created_at=$(echo "$pr_info" | jq -r '.createdAt')
# createdAt は ISO8601 形式 (例: 2025-01-25T10:30:00Z) なので MMDD を抽出
pr_created_mmdd=$(echo "$pr_created_at" | sed -E 's/^[0-9]{4}-([0-9]{2})-([0-9]{2}).*/\1\2/')

# ブランチ名が指定されていない場合は {Author}-#{PR}-{MMDD} を使用
if [[ -z "$branch" ]]; then
    branch="${pr_author}-#${pr_number}-${pr_created_mmdd}"
fi

# PR情報を表示（quiet モードでない場合）
if [[ "$quiet" != true ]]; then
    echo -e "${BOLD}PR #${pr_number}:${NC} ${pr_title}"
    echo -e "  Author: ${YELLOW}${pr_author}${NC}"
    echo -e "  Branch: ${YELLOW}${pr_head_branch}${NC}"
    echo -e "  Commit: ${YELLOW}${pr_sha_short}${NC}"
    echo -e "  URL:    ${pr_url}"
    echo ""
    echo -e "Creating worktree: ${BOLD}${branch}${NC} from ${YELLOW}${pr_sha_short}${NC}"
    echo ""
fi

# git wt を実行し、出力から worktree パスを取得
# git wt は最後に worktree のパスを出力する
if [[ "$quiet" == true ]]; then
    # quiet モードでは git wt の出力を完全に抑制し、パスのみをキャプチャ
    worktree_path=$(git wt "$branch" "$pr_sha" "${wt_options[@]}" 2>&1 | tail -n 1)
else
    # 通常モードでは git wt の出力を表示しながらパスをキャプチャ
    worktree_path=$(git wt "$branch" "$pr_sha" "${wt_options[@]}" | tee /dev/stderr | tail -n 1)
fi

# upstream を設定して git pull できるようにする
# wt-pr で作成したブランチは PR の HEAD コミットから開始するが、
# tracking branch が未設定のため git pull が失敗する
# PR がマージ済みでリモートブランチが削除されている場合は fetch が失敗するためスキップ
if git fetch origin "${pr_head_branch}" 2>/dev/null; then
    git branch --set-upstream-to="origin/${pr_head_branch}" "$branch"
    if [[ "$quiet" != true ]]; then
        echo -e "Set upstream to: ${YELLOW}origin/${pr_head_branch}${NC}"
    fi
else
    if [[ "$quiet" != true ]]; then
        echo -e "${YELLOW}Note: Remote branch '${pr_head_branch}' not found (PR may be merged). Skipping upstream setting.${NC}"
    fi
fi

# quiet モードの場合は worktree パスのみを stdout に出力
if [[ "$quiet" == true ]]; then
    echo "$worktree_path"
fi
