#!/bin/bash
# claudeprint - minimal Claude one-liner wrapper
#  - 実行バイナリ: $HOME/.claude/local/claude を優先。なければ PATH の claude
#  - claude コマンドに -p（print モード）をデフォルト付与
#  - --system-prompt / --allowed-tools を自動で注入（ユーザー指定があれば尊重）
#  - それ以外の引数はすべてそのまま委譲
#  - 標準入力は内容を変更せずに中継

set -euo pipefail

# 実行バイナリ決定
if [[ -x "$HOME/.claude/local/claude" ]]; then
  CLAUDE_BIN="$HOME/.claude/local/claude"
elif command -v claude >/dev/null 2>&1; then
  CLAUDE_BIN="claude"
else
  echo "Error: Claude CLI が見つかりません。 \$HOME/.claude/local/claude または 'claude' を用意してください。" >&2
  exit 127
fi

# デフォルト System Prompt（環境変数で上書き可）
DEFAULT_SYSTEM_PROMPT='You are a minimal, fast, non-proactive assistant. Prefer concise answers. Do not read local files or repositories unless the user explicitly provides paths/flags or file contents. Avoid side effects.'
SYSTEM_PROMPT="${CLAUDEPRINT_SYSTEM_PROMPT:-${CLAUDEMIN_SYSTEM_PROMPT:-$DEFAULT_SYSTEM_PROMPT}}"
DEFAULT_ALLOWED_TOOLS='WebSearch WebFetch Read Grep Glob LS Bash(ls:*) Bash(cat:*) Bash(grep:*) Bash(find:*)'
ALLOWED_TOOLS="${CLAUDEPRINT_ALLOWED_TOOLS:-$DEFAULT_ALLOWED_TOOLS}"

# 引数を解析して -m/--model を抽出し、--system-prompt / --allowed-tools の上書きや -p の指定を検知
ADD_SYSTEM_PROMPT=true
ADD_PRINT=true
ADD_ALLOWED_TOOLS=true
declare -a MODEL_ARGS=()
declare -a FORWARDED_OPTS=()
declare -a PROMPT_ARGS=()

while (($#)); do
  arg="$1"
  case "$arg" in
    --)
      shift
      break
      ;;
    -m|--model)
      if (($# < 2)); then
        echo "Error: option '$arg' requires an argument." >&2
        exit 1
      fi
      if [[ "$arg" == "-m" ]]; then
        MODEL_ARGS+=(--model "$2")
      else
        MODEL_ARGS+=("$arg" "$2")
      fi
      shift 2
      continue
      ;;
    -m=*|--model=*)
      if [[ "$arg" == -m=* ]]; then
        MODEL_ARGS+=(--model="${arg#*=}")
      else
        MODEL_ARGS+=("$arg")
      fi
      shift
      continue
      ;;
    --system-prompt)
      ADD_SYSTEM_PROMPT=false
      if (($# < 2)); then
        echo "Error: option '$arg' requires an argument." >&2
        exit 1
      fi
      FORWARDED_OPTS+=("$arg" "$2")
      shift 2
      continue
      ;;
    --system-prompt=*|-S=*)
      ADD_SYSTEM_PROMPT=false
      FORWARDED_OPTS+=("$arg")
      shift
      continue
      ;;
    -S)
      ADD_SYSTEM_PROMPT=false
      if (($# < 2)); then
        echo "Error: option '$arg' requires an argument." >&2
        exit 1
      fi
      FORWARDED_OPTS+=("$arg" "$2")
      shift 2
      continue
      ;;
    -p|--print)
      ADD_PRINT=false
      FORWARDED_OPTS+=("$arg")
      shift
      continue
      ;;
    --allowed-tools|--allowedTools)
      ADD_ALLOWED_TOOLS=false
      if (($# < 2)); then
        echo "Error: option '$arg' requires an argument." >&2
        exit 1
      fi
      FORWARDED_OPTS+=("$arg" "$2")
      shift 2
      continue
      ;;
    --allowed-tools=*|--allowedTools=*)
      ADD_ALLOWED_TOOLS=false
      FORWARDED_OPTS+=("$arg")
      shift
      continue
      ;;
    -*)
      FORWARDED_OPTS+=("$arg")
      shift
      continue
      ;;
    *)
      break
      ;;
  esac
done

PROMPT_ARGS=("$@")

# 実行（標準入力はそのまま中継）
CLAUDE_CMD=( "$CLAUDE_BIN" )
if ((${#MODEL_ARGS[@]})); then
  CLAUDE_CMD+=("${MODEL_ARGS[@]}")
fi
if "$ADD_PRINT"; then
  CLAUDE_CMD+=(-p)
fi
if "$ADD_SYSTEM_PROMPT"; then
  CLAUDE_CMD+=(--system-prompt "$SYSTEM_PROMPT")
fi
if "$ADD_ALLOWED_TOOLS"; then
  CLAUDE_CMD+=(--allowed-tools "$ALLOWED_TOOLS")
fi
if ((${#FORWARDED_OPTS[@]})); then
  CLAUDE_CMD+=("${FORWARDED_OPTS[@]}")
fi
if ((${#PROMPT_ARGS[@]})); then
  CLAUDE_CMD+=(-- "${PROMPT_ARGS[@]}")
fi

"${CLAUDE_CMD[@]}"
exit $?
